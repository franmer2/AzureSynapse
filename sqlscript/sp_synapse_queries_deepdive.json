{
	"name": "sp_synapse_queries_deepdive",
	"properties": {
		"folder": {
			"name": "Performance Demo"
		},
		"content": {
			"query": "\n\nCREATE PROC [dbo].[sp_whoisactive_deepdive] @request_id [varchar](20),@distributions [bit],@tempdb [bit] AS\n\n\nPRINT ' __        ___   _    _  _____      _    __  __   ___   _     ___   ___  _  _____ _   _  ____      _  _____ ___ '\nPRINT ' \\ \\      / / | | |  / \\|_   _|    / \\  |  \\/  | |_ _| | |   / _ \\ / _ \\| |/ /_ _| \\ | |/ ___|    / \\|_   _|__ \\'\nPRINT '  \\ \\ /\\ / /| |_| | / _ \\ | |     / _ \\ | |\\/| |  | |  | |  | | | | | | |   / | ||  \\| | |  _    / _ \\ | |   / /'\nPRINT '   \\ V  V / |  _  |/ ___ \\| |    / ___ \\| |  | |  | |  | |__| |_| | |_| | . \\ | || |\\  | |_| |  / ___ \\| |  |_| '\nPRINT '    \\_/\\_/  |_| |_/_/   \\_\\_|   /_/   \\_\\_|  |_| |___| |_____\\___/ \\___/|_|\\_\\___|_| \\_|\\____| /_/   \\_\\_|  (_) '\n\n\nPRINT 'READ MORE AT: https://docs.microsoft.com/en-us/azure/synapse-analytics/sql-data-warehouse/sql-data-warehouse-manage-monitor'\n                                                                                                                \n\nPRINT '-> QUERY STEPS/PLAN'\nPRINT '-> SESSION STEPS AND INFORMATION'\nPRINT '-> LOCK ESCALATION'\nIF @distributions = 1\n\tPRINT '-> QUERY STEPS ON ALL DISTRIBUTED DATABASES'\nIF @distributions = 1\n\tPRINT '-> DATA MOVEMENT STEPS ON EACH DISTRIBUTION'\nIF @tempdb = 1\n\tPRINT '-> TEMPDB INFO'\n\n\nSELECT\t*\nFROM\tsys.dm_pdw_request_steps \nWHERE\trequest_id = @request_id\nORDER BY step_index;\n\nSELECT\t\ts.session_id,\n\t\t\ts.request_id,\n\t\t\t--s.login_time,\n\t\t\ts.login_name,\n\t\t\ta.status,\n\t\t\tDATEDIFF(MINUTE,a.start_time,GETDATE()) AS running_time\t,\n\t\t\tDATEDIFF(MINUTE,a.submit_time,a.start_time) AS time_in_queue\t,\n\t\t\tDATEADD(HOUR,2,a.submit_time\t\t) AS submit_time\t\t,\n\t\t\tDATEADD(HOUR,2,a.start_time\t\t\t) AS start_time\t\t\t,\n\t\t\tDATEADD(HOUR,2,a.end_compile_time\t) AS end_compile_time\t,\n\t\t\tDATEADD(HOUR,2,a.end_time\t\t\t) AS end_time\t\t\t,\n\t\t\ta.[label],\n\t\t\ta.command,\n\t\t\t--l.blocking_session_id,\n\t\t\ts.app_name,\n\t\t\tA.resource_class,\n\t\t\tCONCAT('EXEC dbo.sp_whoisactive_deepdive @request_id = ''',s.request_id,''', @distributions = 0, @tempdb = 0') deepdive\nFROM\t\tsys.dm_pdw_exec_sessions s\nLEFT JOIN\tsys.dm_pdw_exec_requests a ON        s.session_id = a.session_id\nWHERE\t\ts.session_id = (SELECT TOP 1 session_id FROM sys.dm_pdw_exec_sessions WHERE request_id = @request_id)\n\nSELECT waits.session_id,\n      waits.request_id,  \n      requests.command,\n      requests.status,\n      requests.start_time,  \n      waits.type,\n      waits.state,\n      waits.object_type,\n      waits.object_name\nFROM   sys.dm_pdw_waits waits\n   JOIN  sys.dm_pdw_exec_requests requests\n   ON waits.request_id=requests.request_id\nWHERE waits.request_id = @request_id\nORDER BY waits.object_name, waits.object_type, waits.state;\n\nIF @distributions = 1\nBEGIN\n\tSELECT * FROM sys.dm_pdw_sql_requests\n\tWHERE request_id = @request_id AND step_index = 2;\n\n\tSELECT * FROM sys.dm_pdw_dms_workers\n\tWHERE request_id = @request_id AND step_index = 2;\nEND\n\nIF @tempdb = 1\nBEGIN\nSELECT\n    sr.request_id,\n    ssu.session_id,\n    ssu.pdw_node_id,\n    sr.command,\n    sr.total_elapsed_time,\n    es.login_name AS 'LoginName',\n    DB_NAME(ssu.database_id) AS 'DatabaseName',\n    (es.memory_usage * 8) AS 'MemoryUsage (in KB)',\n    (ssu.user_objects_alloc_page_count * 8) AS 'Space Allocated For User Objects (in KB)',\n    (ssu.user_objects_dealloc_page_count * 8) AS 'Space Deallocated For User Objects (in KB)',\n    (ssu.internal_objects_alloc_page_count * 8) AS 'Space Allocated For Internal Objects (in KB)',\n    (ssu.internal_objects_dealloc_page_count * 8) AS 'Space Deallocated For Internal Objects (in KB)',\n    CASE es.is_user_process\n    WHEN 1 THEN 'User Session'\n    WHEN 0 THEN 'System Session'\n    END AS 'SessionType',\n    es.row_count AS 'RowCount'\nFROM sys.dm_pdw_nodes_db_session_space_usage AS ssu\n    INNER JOIN sys.dm_pdw_nodes_exec_sessions AS es ON ssu.session_id = es.session_id AND ssu.pdw_node_id = es.pdw_node_id\n    INNER JOIN sys.dm_pdw_nodes_exec_connections AS er ON ssu.session_id = er.session_id AND ssu.pdw_node_id = er.pdw_node_id\n    INNER JOIN microsoft.vw_sql_requests AS sr ON ssu.session_id = sr.spid AND ssu.pdw_node_id = sr.pdw_node_id\nWHERE DB_NAME(ssu.database_id) = 'tempdb'\n    AND es.session_id <> @@SPID\n    AND es.login_name <> 'sa'\n\tAND\tsr.request_id = @request_id\nORDER BY sr.request_id;\nEND",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "master",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}
{
	"name": "Monitoring TempDB",
	"properties": {
		"folder": {
			"name": "Monitoring"
		},
		"content": {
			"query": "----- Create Views\nPRINT 'Info: Creating the ''microsoft.vw_sql_requests'' view';\nGO\n\nCREATE VIEW microsoft.vw_sql_requests\nAS\n(\n\tSELECT\n\t\tsr.request_id,\n\t\tsr.step_index,\n\t\t(CASE WHEN (sr.distribution_id = -1 ) THEN (SELECT pdw_node_id FROM sys.dm_pdw_nodes WHERE type = 'CONTROL') ELSE d.pdw_node_id END) AS pdw_node_id,\n\t\tsr.distribution_id,\n\t\tsr.status,\n\t\tsr.error_id,\n\t\tsr.start_time,\n\t\tsr.end_time,\n\t\tsr.total_elapsed_time,\n\t\tsr.row_count,\n\t\tsr.spid,\n\t\tsr.command\n\tFROM\n\t\tsys.pdw_distributions AS d\n\t\tRIGHT JOIN sys.dm_pdw_sql_requests AS sr ON d.distribution_id = sr.distribution_id\n)\nGO\n------------------------------\n\n\n-- Monitor tempdb\nSELECT\n    sr.request_id,\n    ssu.session_id,\n    ssu.pdw_node_id,\n    sr.command,\n    sr.total_elapsed_time,\n    exs.login_name AS 'LoginName',\n    DB_NAME(ssu.database_id) AS 'DatabaseName',\n    (es.memory_usage * 8) AS 'MemoryUsage (in KB)',\n    (ssu.user_objects_alloc_page_count * 8) AS 'Space Allocated For User Objects (in KB)',\n    (ssu.user_objects_dealloc_page_count * 8) AS 'Space Deallocated For User Objects (in KB)',\n    (ssu.internal_objects_alloc_page_count * 8) AS 'Space Allocated For Internal Objects (in KB)',\n    (ssu.internal_objects_dealloc_page_count * 8) AS 'Space Deallocated For Internal Objects (in KB)',\n    CASE es.is_user_process\n    WHEN 1 THEN 'User Session'\n    WHEN 0 THEN 'System Session'\n    END AS 'SessionType',\n    es.row_count AS 'RowCount'\nFROM sys.dm_pdw_nodes_db_session_space_usage AS ssu\n    INNER JOIN sys.dm_pdw_nodes_exec_sessions AS es ON ssu.session_id = es.session_id AND ssu.pdw_node_id = es.pdw_node_id\n    INNER JOIN sys.dm_pdw_nodes_exec_connections AS er ON ssu.session_id = er.session_id AND ssu.pdw_node_id = er.pdw_node_id\n    INNER JOIN microsoft.vw_sql_requests AS sr ON ssu.session_id = sr.spid AND ssu.pdw_node_id = sr.pdw_node_id\n    LEFT JOIN sys.dm_pdw_exec_requests exr on exr.request_id = sr.request_id\n    LEFT JOIN sys.dm_pdw_exec_sessions exs on exr.session_id = exs.session_id\nWHERE DB_NAME(ssu.database_id) = 'tempdb'\n    AND es.session_id <> @@SPID\n    AND es.login_name <> 'sa'\nORDER BY sr.request_id;",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "franmerSQLPool",
				"poolName": "franmerSQLPool"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}